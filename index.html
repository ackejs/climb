<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Doodle Jump Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
html,body{margin:0;width:100%;height:100%;overflow:hidden;background:#fff;touch-action:none;-webkit-user-select:none;user-select:none}
canvas{display:block;width:100vw;height:100vh}
</style>
</head>
<body>
<canvas id="c"></canvas>
<script>
(()=>{"use strict";
const tg=window.Telegram&&window.Telegram.WebApp?window.Telegram.WebApp:null;if(tg){tg.ready();tg.expand();}
const c=document.getElementById("c"),x=c.getContext("2d");
let W=360,H=640,DPR=1,state="start",last=performance.now(),cam=0,score=0,best=+localStorage.getItem("doodle_best_score")||0,startY=0,minY=0,genY=0,shootCd=0;
const S={gravity:1850,jump:-980,spring:-1520,acc:3300,maxVx:470,fric:.9};
const p={x:0,y:0,w:44,h:52,vx:0,vy:0,dir:1,shield:false,shoes:0,jet:0,prop:0};
const k={l:0,r:0,t:0,g:0,tx:0,ty:0,active:0};
const plats=[],ens=[],bul=[],pow=[],prt=[]; let btnR={x:0,y:0,w:0,h:0},btnS={x:0,y:0,w:0,h:0},pal={};
const rnd=(a,b)=>Math.random()*(b-a)+a,cl=(v,a,b)=>Math.max(a,Math.min(b,v));
const h=(t)=>tg&&tg.HapticFeedback&&tg.HapticFeedback.impactOccurred(t);
function theme(){const d=tg&&tg.colorScheme==="dark";pal=d?{bg:"#0f1625",cloud:"#1e2a42",text:"#e9eefc",sub:"#b9c5e5",g:"#4ade80",b:"#60a5fa",br:"#8b5e34",w:"#d4def6",spr:"#f59e0b",e:"#f87171",dd:"#22c55e",line:"#111827",bullet:"#fde047",ov:"rgba(10,18,32,.6)",btn:"#2563eb",bt:"#fff"}:{bg:"#fff",cloud:"#e8f4ff",text:"#111827",sub:"#4b5563",g:"#3bbf57",b:"#52a7ff",br:"#9a6a3f",w:"#fff",spr:"#f59e0b",e:"#ef4444",dd:"#33c15d",line:"#111827",bullet:"#f59e0b",ov:"rgba(255,255,255,.75)",btn:"#2563eb",bt:"#fff"};}
function resize(){W=Math.max(320,innerWidth);H=Math.max(540,innerHeight);DPR=Math.min(devicePixelRatio||1,2);c.width=W*DPR;c.height=H*DPR;c.style.width=W+"px";c.style.height=H+"px";x.setTransform(DPR,0,0,DPR,0,0);}
function rr(ctx,a,b,w,h,r){r=Math.min(r,w*.5,h*.5);ctx.beginPath();ctx.moveTo(a+r,b);ctx.arcTo(a+w,b,a+w,b+h,r);ctx.arcTo(a+w,b+h,a,b+h,r);ctx.arcTo(a,b+h,a,b,r);ctx.arcTo(a,b,a+w,b,r);ctx.closePath();}
function mbtn(v){if(!tg||!tg.MainButton)return; if(v){tg.MainButton.setText("Share Score");tg.MainButton.show();} else tg.MainButton.hide();}
function sendScore(){tg&&tg.sendData(String(Math.floor(score)));}
function plat(y){const hp=Math.max(0,(startY-y)/1200),r=Math.random();let t="green";if(hp>.4&&r<.14)t="blue";else if(hp>.7&&r<.25)t="brown";else if(hp>1.2&&r<.33)t="white";const w=rnd(62,92);const q={x:rnd(20,W-20-w),y,w,h:16,t,vx:t==="blue"?rnd(55,120)*(Math.random()<.5?-1:1):0,a:1,br:0,bvy:0,dt:0,spr:0};if((t==="green"||t==="blue")&&Math.random()<.12)q.spr=1;return q;}
function maybeEnemy(y){if(score<700||Math.random()>.12)return;const t=Math.random()<.5?"ufo":"monster";ens.push({t,x:rnd(30,W-30),y:y-rnd(20,90),w:t==="ufo"?54:50,h:t==="ufo"?26:42,vx:rnd(35,85)*(Math.random()<.5?-1:1),a:1});}
function maybePow(q){if(Math.random()>.09)return;const r=Math.random();let t="spring";if(r<.25)t="jet";else if(r<.5)t="shield";else if(r<.75)t="prop";pow.push({t,x:q.x+q.w*.5,y:q.y-20,w:28,h:24,a:1});}
function generate(){const ty=cam-H*1.6;while(genY>ty){genY-=rnd(58,92);const q=plat(genY);plats.push(q);if(Math.random()<.18)maybePow(q);if(Math.random()<.11)maybeEnemy(q.y);}}
function reset(){plats.length=ens.length=bul.length=pow.length=prt.length=0;p.x=W*.5;p.y=H*.72;p.vx=0;p.vy=S.jump;p.dir=1;p.shield=0;p.shoes=0;p.jet=0;p.prop=0;startY=p.y;minY=p.y;cam=0;genY=H-40;score=0;shootCd=0;let y=H-20;for(let i=0;i<12;i++){const q=plat(y);q.t="green";q.vx=0;q.spr=i===4;plats.push(q);y-=rnd(55,80);}genY=Math.min(...plats.map(v=>v.y));generate();}
function start(){state="play";mbtn(0);reset();}
function over(){if(state!=="play")return;state="over";h("heavy");if(score>best){best=Math.floor(score);localStorage.setItem("doodle_best_score",best);}mbtn(1);}
function burst(X,Y,col){for(let i=0;i<12;i++){const a=Math.random()*Math.PI*2,s=rnd(90,220);prt.push({x:X,y:Y,vx:Math.cos(a)*s,vy:Math.sin(a)*s,l:rnd(.25,.5),a:0,c:col});}}
function shoot(tx){if(shootCd>0||state!=="play")return;shootCd=.22;const dx=cl((tx-p.x)*2.8,-220,220);bul.push({x:p.x,y:p.y-p.h*.35,vx:dx,vy:-980,r:5,a:1});}
function power(t){if(t==="jet"){p.jet=2.3;p.prop=0;p.vy=-1320;}else if(t==="spring"){p.shoes=7;}else if(t==="shield"){p.shield=1;}else if(t==="prop"){p.prop=1.9;p.jet=0;p.vy=-1160;}}
function moveIn(){if(k.l&&!k.r)return-1;if(k.r&&!k.l)return 1;if(k.t)return k.t;return k.g;}
function updPlayer(dt){const i=moveIn();p.vx+=i*S.acc*dt;p.vx=cl(p.vx,-S.maxVx,S.maxVx);if(!i)p.vx*=Math.pow(S.fric,dt*60);if(Math.abs(p.vx)>10)p.dir=p.vx>0?1:-1;let g=S.gravity;if(p.jet>0||p.prop>0)g*=.2;p.vy+=g*dt;if(p.jet>0){p.jet-=dt;p.vy+=-3000*dt;}if(p.prop>0){p.prop-=dt;p.vy+=-2200*dt;}if(p.shoes>0)p.shoes-=dt;const pb=p.y+p.h*.5;p.x+=p.vx*dt;p.y+=p.vy*dt;if(p.x<-p.w*.5)p.x=W+p.w*.5;if(p.x>W+p.w*.5)p.x=-p.w*.5;const cb=p.y+p.h*.5;
if(p.vy>0&&p.jet<=0&&p.prop<=0){for(let n=0;n<plats.length;n++){const q=plats[n];if(!q.a||q.br)continue;const overX=p.x+p.w*.2>q.x&&p.x-p.w*.2<q.x+q.w,cross=pb<=q.y&&cb>=q.y;if(overX&&cross){p.y=q.y-p.h*.5;let j=S.jump;if(p.shoes>0)j*=1.25;if(q.spr){j=S.spring;q.spr=0;}p.vy=j;h("medium");if(q.t==="brown"){q.br=1;q.bvy=90;}if(q.t==="white")q.dt=.08;break;}}}
if(p.y<minY){minY=p.y;score=Math.max(score,Math.floor(startY-minY));}const sy=p.y-cam;if(sy<H*.45)cam=p.y-H*.45;if(p.y-cam>H+120)over();}
function updPlats(dt){for(let n=0;n<plats.length;n++){const q=plats[n];if(q.t==="blue"&&q.a&&!q.br){q.x+=q.vx*dt;if(q.x<0||q.x+q.w>W){q.vx*=-1;q.x=cl(q.x,0,W-q.w);}}if(q.br){q.bvy+=1300*dt;q.y+=q.bvy*dt;if(q.y-cam>H+120)q.a=0;}if(q.dt>0){q.dt-=dt;if(q.dt<=0)q.a=0;}}generate();for(let i=plats.length-1;i>=0;i--)if(plats[i].y-cam>H+180||!plats[i].a)plats.splice(i,1);}
function updBul(dt){for(let i=bul.length-1;i>=0;i--){const b=bul[i];if(!b.a){bul.splice(i,1);continue;}b.x+=b.vx*dt;b.y+=b.vy*dt;if(b.y-cam<-60||b.x<-80||b.x>W+80){bul.splice(i,1);continue;}for(let j=ens.length-1;j>=0;j--){const e=ens[j];if(!e.a)continue;if(b.x>e.x-e.w*.5&&b.x<e.x+e.w*.5&&b.y>e.y-e.h*.5&&b.y<e.y+e.h*.5){e.a=0;b.a=0;score+=120;burst(e.x,e.y,"#f87171");break;}}}}
function updEn(dt){for(let i=ens.length-1;i>=0;i--){const e=ens[i];if(!e.a){ens.splice(i,1);continue;}e.x+=e.vx*dt;if(e.x<e.w*.5||e.x>W-e.w*.5){e.vx*=-1;e.x=cl(e.x,e.w*.5,W-e.w*.5);}if(Math.abs(p.x-e.x)<p.w*.5+e.w*.42&&Math.abs(p.y-e.y)<p.h*.5+e.h*.42){if(p.shield){p.shield=0;e.a=0;burst(e.x,e.y,"#60a5fa");}else over();}if(e.y-cam>H+180)ens.splice(i,1);}}
function updPow(){for(let i=pow.length-1;i>=0;i--){const q=pow[i];if(!q.a){pow.splice(i,1);continue;}if(Math.abs(p.x-q.x)<p.w*.45+q.w*.4&&Math.abs(p.y-q.y)<p.h*.45+q.h*.45){power(q.t);q.a=0;burst(q.x,q.y,"#22c55e");}if(q.y-cam>H+180)pow.splice(i,1);}}
function updPrt(dt){for(let i=prt.length-1;i>=0;i--){const q=prt[i];q.a+=dt;q.vy+=500*dt;q.x+=q.vx*dt;q.y+=q.vy*dt;if(q.a>=q.l)prt.splice(i,1);}}
function update(dt){if(state!=="play")return;shootCd=Math.max(0,shootCd-dt);updPlayer(dt);updPlats(dt);updEn(dt);updBul(dt);updPow();updPrt(dt);}
function bg(){x.fillStyle=pal.bg;x.fillRect(0,0,W,H);x.fillStyle=pal.cloud;for(let i=0;i<8;i++){const X=((i*137)+(cam*.08))%(W+180)-90,Y=((i*181)+(cam*.05))%(H+220)-110;x.beginPath();x.ellipse(X,Y,50,18,0,0,Math.PI*2);x.fill();}}
function drawPlat(q){if(!q.a&&!q.br)return;const y=q.y-cam;if(y<-50||y>H+50)return;let col=pal.g;if(q.t==="blue")col=pal.b;else if(q.t==="brown")col=pal.br;else if(q.t==="white")col=pal.w;x.save();if(q.dt>0)x.globalAlpha=cl(q.dt/.08,0,1);x.fillStyle=col;x.strokeStyle=pal.line;x.lineWidth=2;rr(x,q.x,y,q.w,q.h,7);x.fill();x.stroke();if(q.spr){const cx=q.x+q.w*.5,cy=y-2;x.strokeStyle=pal.spr;x.lineWidth=3;x.beginPath();x.moveTo(cx-10,cy);x.lineTo(cx-5,cy-8);x.lineTo(cx,cy);x.lineTo(cx+5,cy-8);x.lineTo(cx+10,cy);x.stroke();x.fillStyle="#fbbf24";rr(x,cx-10,cy-11,20,6,3);x.fill();}x.restore();}
function drawEnemy(e){const y=e.y-cam;if(y<-80||y>H+80)return;if(e.t==="ufo"){x.fillStyle="#93c5fd";x.beginPath();x.ellipse(e.x,y,e.w*.5,e.h*.45,0,0,Math.PI*2);x.fill();x.fillStyle=pal.e;x.beginPath();x.ellipse(e.x,y+4,e.w*.35,e.h*.3,0,0,Math.PI*2);x.fill();}else{x.fillStyle=pal.e;rr(x,e.x-e.w*.5,y-e.h*.5,e.w,e.h,12);x.fill();x.fillStyle="#111827";x.beginPath();x.arc(e.x-9,y-5,3,0,Math.PI*2);x.arc(e.x+9,y-5,3,0,Math.PI*2);x.fill();}}
function drawPow(q){const y=q.y-cam;if(y<-60||y>H+60)return;x.save();x.translate(q.x,y);if(q.t==="jet"){x.fillStyle="#ef4444";rr(x,-10,-14,20,28,6);x.fill();x.fillStyle="#f59e0b";x.fillRect(-6,14,4,8);x.fillRect(2,14,4,8);}else if(q.t==="spring"){x.fillStyle="#22c55e";rr(x,-13,-8,26,16,5);x.fill();x.strokeStyle="#f59e0b";x.lineWidth=2;x.beginPath();x.moveTo(-9,10);x.lineTo(-3,16);x.lineTo(3,10);x.lineTo(9,16);x.stroke();}else if(q.t==="shield"){x.fillStyle="#60a5fa";x.beginPath();x.moveTo(0,-15);x.lineTo(12,-8);x.lineTo(9,8);x.lineTo(0,15);x.lineTo(-9,8);x.lineTo(-12,-8);x.closePath();x.fill();}else{x.fillStyle="#a78bfa";rr(x,-10,-10,20,20,6);x.fill();x.strokeStyle="#111827";x.lineWidth=2;x.beginPath();x.moveTo(-16,-12);x.lineTo(16,-12);x.stroke();}x.restore();}
function drawBul(){x.fillStyle=pal.bullet;for(const b of bul){const y=b.y-cam;x.beginPath();x.arc(b.x,y,b.r,0,Math.PI*2);x.fill();}}
function drawPrt(){for(const q of prt){const a=1-q.a/q.l;if(a<=0)continue;x.globalAlpha=a;x.fillStyle=q.c;x.beginPath();x.arc(q.x,q.y-cam,2.5,0,Math.PI*2);x.fill();}x.globalAlpha=1;}
function drawP(){const X=p.x,Y=p.y-cam;x.fillStyle=pal.dd;rr(x,X-p.w*.5,Y-p.h*.5,p.w,p.h,14);x.fill();x.strokeStyle=pal.line;x.lineWidth=2;rr(x,X-p.w*.5,Y-p.h*.5,p.w,p.h,14);x.stroke();x.fillStyle="#f59e0b";rr(x,X-15,Y+p.h*.34,12,7,3);rr(x,X+3,Y+p.h*.34,12,7,3);x.fill();if(p.shoes>0){x.strokeStyle="#f59e0b";x.lineWidth=2;x.beginPath();x.moveTo(X-15,Y+p.h*.47);x.lineTo(X-9,Y+p.h*.56);x.lineTo(X-3,Y+p.h*.47);x.moveTo(X+3,Y+p.h*.47);x.lineTo(X+9,Y+p.h*.56);x.lineTo(X+15,Y+p.h*.47);x.stroke();}if(p.shield){x.strokeStyle="#60a5fa";x.lineWidth=3;x.beginPath();x.arc(X,Y,34,0,Math.PI*2);x.stroke();}if(p.jet>0||p.prop>0){x.fillStyle="#ef4444";rr(x,X-18,Y-12,8,24,3);rr(x,X+10,Y-12,8,24,3);x.fill();x.fillStyle="#f59e0b";x.beginPath();x.moveTo(X-14,Y+14);x.lineTo(X-18,Y+26);x.lineTo(X-10,Y+26);x.closePath();x.moveTo(X+14,Y+14);x.lineTo(X+10,Y+26);x.lineTo(X+18,Y+26);x.closePath();x.fill();}if(p.prop>0){x.strokeStyle="#111827";x.lineWidth=2;x.beginPath();x.moveTo(X-18,Y-p.h*.56);x.lineTo(X+18,Y-p.h*.56);x.stroke();}
const fx=X+p.dir*5,fy=Y-7,dx=k.tx-fx,dy=k.ty-fy,d=Math.max(1,Math.hypot(dx,dy)),ex=dx/d*2.5,ey=dy/d*2.5;x.fillStyle="#fff";x.beginPath();x.arc(fx-8,fy,6,0,Math.PI*2);x.arc(fx+8,fy,6,0,Math.PI*2);x.fill();x.fillStyle="#111827";x.beginPath();x.arc(fx-8+ex,fy+ey,2.4,0,Math.PI*2);x.arc(fx+8+ex,fy+ey,2.4,0,Math.PI*2);x.fill();}
function hud(){x.fillStyle=pal.text;x.textAlign="center";x.textBaseline="top";x.font="700 30px Arial";x.fillText(String(Math.floor(score)),W*.5,14);x.textAlign="left";x.font="600 15px Arial";x.fillStyle=pal.sub;x.fillText(`BEST: ${best}`,14,14);let t="";if(p.jet>0)t=`JETPACK ${p.jet.toFixed(1)}s`;else if(p.prop>0)t=`PROPELLER ${p.prop.toFixed(1)}s`;else if(p.shoes>0)t=`SPRING SHOES ${p.shoes.toFixed(1)}s`;else if(p.shield)t="SHIELD ON";if(t){x.fillStyle="#2563eb";x.font="700 14px Arial";x.fillText(t,14,36);}}
function drawBtn(r,t){x.fillStyle=pal.btn;rr(x,r.x,r.y,r.w,r.h,12);x.fill();x.fillStyle=pal.bt;x.font="700 20px Arial";x.textAlign="center";x.textBaseline="middle";x.fillText(t,r.x+r.w*.5,r.y+r.h*.5+1);}
function startScr(){bg();x.fillStyle=pal.text;x.textAlign="center";x.textBaseline="middle";x.font="700 48px Arial";x.fillText("DOODLE JUMP",W*.5,H*.28);x.font="700 34px Arial";x.fillText("TAP TO PLAY",W*.5,H*.5);x.font="600 20px Arial";x.fillStyle=pal.sub;x.fillText(`BEST: ${best}`,W*.5,H*.62);x.font="500 15px Arial";x.fillText("Move: touch halves / arrows / A D / gyro",W*.5,H*.72);x.fillText("Shoot: tap above doodler",W*.5,H*.76);}
function overScr(){bg();for(const q of plats)drawPlat(q);for(const q of pow)drawPow(q);for(const e of ens)drawEnemy(e);drawBul();drawP();drawPrt();x.fillStyle=pal.ov;x.fillRect(0,0,W,H);x.fillStyle=pal.text;x.textAlign="center";x.textBaseline="middle";x.font="700 48px Arial";x.fillText("GAME OVER",W*.5,H*.26);x.font="700 30px Arial";x.fillText(`SCORE: ${Math.floor(score)}`,W*.5,H*.38);x.font="600 22px Arial";x.fillStyle=pal.sub;x.fillText(`BEST: ${best}`,W*.5,H*.45);btnR={x:W*.5-120,y:H*.56,w:240,h:56};btnS={x:W*.5-120,y:H*.66,w:240,h:56};drawBtn(btnR,"RESTART");drawBtn(btnS,"SHARE SCORE");}
function playScr(){bg();for(const q of plats)drawPlat(q);for(const q of pow)drawPow(q);for(const e of ens)drawEnemy(e);drawBul();drawP();drawPrt();hud();}
function draw(){if(state==="start")startScr();else if(state==="play")playScr();else overScr();}
function pos(e){const r=c.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top};}
function inR(r,x,y){return x>=r.x&&x<=r.x+r.w&&y>=r.y&&y<=r.y+r.h;}
async function gyroPerm(){const D=window.DeviceOrientationEvent;if(!D||typeof D.requestPermission!=="function")return;try{const s=await D.requestPermission();if(s!=="granted")k.g=0;}catch(_){k.g=0;}}
function pDown(e){const P=pos(e);k.tx=P.x;k.ty=P.y;if(state==="start"){start();gyroPerm();return;}if(state==="over"){if(inR(btnR,P.x,P.y)){start();return;}if(inR(btnS,P.x,P.y)){sendScore();return;}start();return;}const ps=p.y-cam;if(P.y<ps-24)shoot(P.x);k.active=1;k.t=P.x<W*.5?-1:1;}
function pMove(e){const P=pos(e);k.tx=P.x;k.ty=P.y;if(k.active&&state==="play")k.t=P.x<W*.5?-1:1;}
function pUp(){k.active=0;k.t=0;}
function kd(e){if(e.code==="ArrowLeft"||e.code==="KeyA"){k.l=1;e.preventDefault();}if(e.code==="ArrowRight"||e.code==="KeyD"){k.r=1;e.preventDefault();}if(e.code==="Space"&&state==="play"){shoot(p.x);e.preventDefault();}if((e.code==="Enter"||e.code==="Space")&&state!=="play"){start();e.preventDefault();}}
function ku(e){if(e.code==="ArrowLeft"||e.code==="KeyA"){k.l=0;e.preventDefault();}if(e.code==="ArrowRight"||e.code==="KeyD"){k.r=0;e.preventDefault();}}
function orient(e){k.g=cl(Number.isFinite(e.gamma)?e.gamma/24:0,-1,1);}
function loop(ts){const dt=cl((ts-last)/1000,0,.033);last=ts;update(dt);draw();requestAnimationFrame(loop);}
addEventListener("resize",resize);c.addEventListener("pointerdown",pDown);c.addEventListener("pointermove",pMove);c.addEventListener("pointerup",pUp);c.addEventListener("pointercancel",pUp);document.addEventListener("keydown",kd);document.addEventListener("keyup",ku);addEventListener("deviceorientation",orient);
if(tg&&tg.onEvent)tg.onEvent("themeChanged",theme);if(tg&&tg.MainButton)tg.MainButton.onClick(sendScore);
theme();resize();mbtn(0);requestAnimationFrame(loop);
})();
</script>
</body>
</html>
